## **ğŸš€ "GIáº¢I MÃƒ" CTE (COMMON TABLE EXPRESSIONS) TRONG SQL SERVER: "TRUY Váº¤N Táº M" CHO DÃ‚N CODE ğŸš€**

Yo cÃ¡c báº¡n sinh viÃªn IT! HÃ´m nay chÃºng ta sáº½ cÃ¹ng nhau "khÃ¡m phÃ¡" má»™t khÃ¡i niá»‡m ráº¥t quan trá»ng trong SQL Server: Common
Table Expressions (CTE). Nghe cÃ³ váº» "láº¡ tai" nhÆ°ng thá»±c ra ráº¥t há»¯u Ã­ch khi báº¡n cáº§n viáº¿t cÃ¡c query phá»©c táº¡p. CÃ¹ng mÃ¬nh "
má»• xáº»" nÃ³ nhÃ©!

### **I. CTE (COMMON TABLE EXPRESSIONS) LÃ€ GÃŒ? (NHÆ¯ "Báº¢NG Táº M" TRONG QUERY)**

- **CTE (Common Table Expressions):** LÃ  má»™t _táº­p káº¿t quáº£ táº¡m thá»i_ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong má»™t cÃ¢u lá»‡nh SQL, vÃ  cÃ³ thá»ƒ
  Ä‘Æ°á»£c tham chiáº¿u Ä‘áº¿n trong cÃ¢u lá»‡nh Ä‘Ã³.
- **NÃ³ hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?**
    - Giá»‘ng nhÆ° khi báº¡n táº¡o má»™t biáº¿n táº¡m Ä‘á»ƒ lÆ°u káº¿t quáº£ tÃ­nh toÃ¡n: báº¡n cÃ³ thá»ƒ dÃ¹ng biáº¿n táº¡m Ä‘Ã³ trong cÃ¡c cÃ´ng thá»©c tÃ­nh
      tiáº¿p theo.
- **Quan trá»ng vÃ¬:**
    - **Chia nhá»:** Chia nhá» truy váº¥n phá»©c táº¡p thÃ nh cÃ¡c pháº§n nhá» hÆ¡n, dá»… Ä‘á»c hÆ¡n.
    - **TÃ¡i sá»­ dá»¥ng:** DÃ¹ng láº¡i logic tÃ­nh toÃ¡n á»Ÿ nhiá»u nÆ¡i.
    - **Äá»‡ quy:** Cho phÃ©p táº¡o cÃ¡c truy váº¥n Ä‘á»‡ quy (vÃ­ dá»¥: tÃ¬m cáº¥p báº­c nhÃ¢n viÃªn trong cÃ´ng ty).

### **II. CÃš PHÃP CÆ  Báº¢N (CÃCH DÃ™NG CTE)**

```sql
WITH cte_name AS (
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition
)
SELECT column1, column2, ...
FROM cte_name
WHERE condition;
```

- **`WITH cte_name AS (...)`:** Táº¡o CTE vá»›i tÃªn `cte_name`, bÃªn trong lÃ  cÃ¢u truy váº¥n `SELECT`.
- **`SELECT column1, column2, ... FROM cte_name`:** Sá»­ dá»¥ng CTE `cte_name` trong truy váº¥n chÃ­nh.
- **`WHERE condition`:** CÃ¡c Ä‘iá»u kiá»‡n lá»c (náº¿u cáº§n).

### **III. VÃ Dá»¤ MINH Há»ŒA (XEM "THá»°C HÃ€NH")**

Giáº£ sá»­ ta cÃ³ báº£ng:

- **`Employees`:** (EmployeeID, FirstName, LastName, Department, Salary)

#### **1. CTE ÄÆ N GIáº¢N (Láº¤Y TÃŠN VÃ€ LÆ¯Æ NG NHÃ‚N VIÃŠN PHÃ’NG IT):**

```sql
WITH IT_Employees AS (
    SELECT FirstName, LastName, Salary
    FROM Employees
    WHERE Department = 'IT'
)
SELECT *
FROM IT_Employees;
```

- **Giáº£i thÃ­ch:**
    - Táº¡o CTE `IT_Employees` Ä‘á»ƒ láº¥y thÃ´ng tin nhÃ¢n viÃªn phÃ²ng IT.
    - DÃ¹ng `SELECT * FROM IT_Employees` Ä‘á»ƒ láº¥y dá»¯ liá»‡u tá»« CTE.

#### **2. CTE DÃ™NG TRONG JOIN (Láº¤Y TÃŠN NHÃ‚N VIÃŠN VÃ€ LÆ¯Æ NG TRUNG BÃŒNH THEO PHÃ’NG BAN):**

```sql
WITH AvgSalaryByDepartment AS (
    SELECT Department, AVG(Salary) AS AvgSalary
    FROM Employees
    GROUP BY Department
)
SELECT e.FirstName, e.LastName, a.AvgSalary
FROM Employees e
JOIN AvgSalaryByDepartment a
ON e.Department = a.Department;
```

- **Giáº£i thÃ­ch:**
    - Táº¡o CTE `AvgSalaryByDepartment` Ä‘á»ƒ tÃ­nh lÆ°Æ¡ng trung bÃ¬nh cá»§a tá»«ng phÃ²ng ban.
    - DÃ¹ng `JOIN` Ä‘á»ƒ káº¿t há»£p thÃ´ng tin nhÃ¢n viÃªn vÃ  lÆ°Æ¡ng trung bÃ¬nh.

#### **3. CTE Äá»† QUY (TÃŒM Cáº¤P DÆ¯á»šI Cá»¦A Má»˜T NHÃ‚N VIÃŠN):**

Giáº£ sá»­ ta cÃ³ báº£ng `EmployeeHierarchy` (EmployeeID, ManagerID, EmployeeName), trong Ä‘Ã³ ManagerID chá»‰ ra ngÆ°á»i quáº£n lÃ½
trá»±c tiáº¿p.

```sql
WITH EmployeeHierarchyCTE AS (
    SELECT EmployeeID, ManagerID, EmployeeName, 0 AS Level
    FROM EmployeeHierarchy
    WHERE EmployeeID = 100 -- EmployeeID cáº§n tÃ¬m
    UNION ALL
    SELECT e.EmployeeID, e.ManagerID, e.EmployeeName, Level + 1
    FROM EmployeeHierarchy e
    INNER JOIN EmployeeHierarchyCTE c ON e.ManagerID = c.EmployeeID
)
SELECT EmployeeID, EmployeeName, Level
FROM EmployeeHierarchyCTE
ORDER BY Level;
```

- **Giáº£i thÃ­ch:**
    - Táº¡o CTE Ä‘á»‡ quy `EmployeeHierarchyCTE` Ä‘á»ƒ tÃ¬m táº¥t cáº£ cÃ¡c cáº¥p dÆ°á»›i cá»§a nhÃ¢n viÃªn cÃ³ `EmployeeID = 100`.
    - Pháº§n Ä‘áº§u (anchor) chá»n nhÃ¢n viÃªn cÃ³ ID lÃ  100, Level = 0.
    - Pháº§n Ä‘á»‡ quy chá»n cÃ¡c nhÃ¢n viÃªn lÃ  cáº¥p dÆ°á»›i dá»±a trÃªn `ManagerID`.
    - DÃ¹ng `UNION ALL` Ä‘á»ƒ káº¿t há»£p káº¿t quáº£ cá»§a cáº£ pháº§n anchor vÃ  pháº§n Ä‘á»‡ quy.

### **IV. Æ¯U ÄIá»‚M Cá»¦A CTE (NHá»®NG ÄIá»‚M "ÄÃNG YÃŠU")**

- **Dá»… Ä‘á»c:** Chia nhá» query phá»©c táº¡p thÃ nh cÃ¡c pháº§n nhá» dá»… hiá»ƒu.
- **TÃ¡i sá»­ dá»¥ng:** DÃ¹ng láº¡i CTE á»Ÿ nhiá»u nÆ¡i trong cÃ¹ng má»™t query.
- **Äá»‡ quy:** CÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ táº¡o truy váº¥n Ä‘á»‡ quy (tÃ­nh toÃ¡n theo cáº¥p).
- **Thay tháº¿ View:** ÄÃ´i khi dÃ¹ng CTE thay vÃ¬ táº¡o view (náº¿u chá»‰ dÃ¹ng trong query hiá»‡n táº¡i).

### **V. NHÆ¯á»¢C ÄIá»‚M Cá»¦A CTE (ÄIá»‚M "KHÃ“ CHá»ŠU")**

- **Chá»‰ dÃ¹ng trong 1 query:** CTE chá»‰ tá»“n táº¡i trong cÃ¢u query hiá»‡n táº¡i.
- **KhÃ´ng cÃ³ chá»‰ má»¥c:** KhÃ´ng táº¡o Ä‘Æ°á»£c index cho CTE.
- **Phá»©c táº¡p hÆ¡n khi má»›i lÃ m quen:** CÃ³ thá»ƒ máº¥t thá»i gian Ä‘á»ƒ lÃ m quen vá»›i CTE Ä‘á»‡ quy.

### **VI. LÆ¯U Ã QUAN TRá»ŒNG (Äá»‚ KHÃ”NG Bá»Š "SAI SÃ“T")**

- **Äáº·t tÃªn rÃµ rÃ ng:** Äáº·t tÃªn CTE dá»… hiá»ƒu, mÃ´ táº£ Ä‘Æ°á»£c má»¥c Ä‘Ã­ch.
- **DÃ¹ng khi cáº§n thiáº¿t:** KhÃ´ng nÃªn dÃ¹ng CTE quÃ¡ nhiá»u, lÃ m query khÃ³ Ä‘á»c.
- **Khi dÃ¹ng Ä‘á»‡ quy:** Cáº§n cÃ³ Ä‘iá»ƒm dá»«ng, Ä‘á»ƒ trÃ¡nh vÃ²ng láº·p vÃ´ háº¡n.
- **Hiá»‡u suáº¥t:** CÃ³ thá»ƒ khÃ´ng cáº£i thiá»‡n hiá»‡u suáº¥t (chá»‰ giÃºp code dá»… hiá»ƒu).

### **VII. Káº¾T LUáº¬N (Tá»”NG Káº¾T)**

CTE lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ giÃºp báº¡n viáº¿t cÃ¡c truy váº¥n phá»©c táº¡p má»™t cÃ¡ch dá»… dÃ ng hÆ¡n trong SQL Server. Hy vá»ng qua bÃ i
viáº¿t nÃ y, cÃ¡c báº¡n Ä‘Ã£ hiá»ƒu rÃµ hÆ¡n vá» nÃ³ vÃ  cÃ³ thá»ƒ Ã¡p dá»¥ng vÃ o cÃ´ng viá»‡c hÃ ng ngÃ y. ChÃºc cÃ¡c báº¡n code thÃ nh cÃ´ng! ğŸ˜

## **üöÄ "GI·∫¢I M√É" CTE (COMMON TABLE EXPRESSIONS) TRONG SQL SERVER: "TRUY V·∫§N T·∫†M" CHO D√ÇN CODE üöÄ**

Yo c√°c b·∫°n sinh vi√™n IT! H√¥m nay ch√∫ng ta s·∫Ω c√πng nhau "kh√°m ph√°" m·ªôt kh√°i ni·ªám r·∫•t quan tr·ªçng trong SQL Server: Common Table Expressions (CTE). Nghe c√≥ v·∫ª "l·∫° tai" nh∆∞ng th·ª±c ra r·∫•t h·ªØu √≠ch khi b·∫°n c·∫ßn vi·∫øt c√°c query ph·ª©c t·∫°p. C√πng m√¨nh "m·ªï x·∫ª" n√≥ nh√©!

### **I. CTE (COMMON TABLE EXPRESSIONS) L√Ä G√å? (NH∆Ø "B·∫¢NG T·∫†M" TRONG QUERY)**

-   **CTE (Common Table Expressions):** L√† m·ªôt _t·∫≠p k·∫øt qu·∫£ t·∫°m th·ªùi_ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong m·ªôt c√¢u l·ªánh SQL, v√† c√≥ th·ªÉ ƒë∆∞·ª£c tham chi·∫øu ƒë·∫øn trong c√¢u l·ªánh ƒë√≥.
-   **N√≥ ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?**
    -   Gi·ªëng nh∆∞ khi b·∫°n t·∫°o m·ªôt bi·∫øn t·∫°m ƒë·ªÉ l∆∞u k·∫øt qu·∫£ t√≠nh to√°n: b·∫°n c√≥ th·ªÉ d√πng bi·∫øn t·∫°m ƒë√≥ trong c√°c c√¥ng th·ª©c t√≠nh ti·∫øp theo.
-   **Quan tr·ªçng v√¨:**
    -   **Chia nh·ªè:** Chia nh·ªè truy v·∫•n ph·ª©c t·∫°p th√†nh c√°c ph·∫ßn nh·ªè h∆°n, d·ªÖ ƒë·ªçc h∆°n.
    -   **T√°i s·ª≠ d·ª•ng:** D√πng l·∫°i logic t√≠nh to√°n ·ªü nhi·ªÅu n∆°i.
    -   **ƒê·ªá quy:** Cho ph√©p t·∫°o c√°c truy v·∫•n ƒë·ªá quy (v√≠ d·ª•: t√¨m c·∫•p b·∫≠c nh√¢n vi√™n trong c√¥ng ty).

### **II. C√ö PH√ÅP C∆† B·∫¢N (C√ÅCH D√ôNG CTE)**

```sql
WITH cte_name AS (
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition
)
SELECT column1, column2, ...
FROM cte_name
WHERE condition;
```

-   **`WITH cte_name AS (...)`:** T·∫°o CTE v·ªõi t√™n `cte_name`, b√™n trong l√† c√¢u truy v·∫•n `SELECT`.
-   **`SELECT column1, column2, ... FROM cte_name`:** S·ª≠ d·ª•ng CTE `cte_name` trong truy v·∫•n ch√≠nh.
-   **`WHERE condition`:** C√°c ƒëi·ªÅu ki·ªán l·ªçc (n·∫øu c·∫ßn).

### **III. V√ç D·ª§ MINH H·ªåA (XEM "TH·ª∞C H√ÄNH")**

Gi·∫£ s·ª≠ ta c√≥ b·∫£ng:

-   **`Employees`:** (EmployeeID, FirstName, LastName, Department, Salary)

#### **1. CTE ƒê∆†N GI·∫¢N (L·∫§Y T√äN V√Ä L∆Ø∆†NG NH√ÇN VI√äN PH√íNG IT):**

```sql
WITH IT_Employees AS (
    SELECT FirstName, LastName, Salary
    FROM Employees
    WHERE Department = 'IT'
)
SELECT *
FROM IT_Employees;
```

-   **Gi·∫£i th√≠ch:**
    -   T·∫°o CTE `IT_Employees` ƒë·ªÉ l·∫•y th√¥ng tin nh√¢n vi√™n ph√≤ng IT.
    -   D√πng `SELECT * FROM IT_Employees` ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ CTE.

#### **2. CTE D√ôNG TRONG JOIN (L·∫§Y T√äN NH√ÇN VI√äN V√Ä L∆Ø∆†NG TRUNG B√åNH THEO PH√íNG BAN):**

```sql
WITH AvgSalaryByDepartment AS (
    SELECT Department, AVG(Salary) AS AvgSalary
    FROM Employees
    GROUP BY Department
)
SELECT e.FirstName, e.LastName, a.AvgSalary
FROM Employees e
JOIN AvgSalaryByDepartment a
ON e.Department = a.Department;
```

-   **Gi·∫£i th√≠ch:**
    -   T·∫°o CTE `AvgSalaryByDepartment` ƒë·ªÉ t√≠nh l∆∞∆°ng trung b√¨nh c·ªßa t·ª´ng ph√≤ng ban.
    -   D√πng `JOIN` ƒë·ªÉ k·∫øt h·ª£p th√¥ng tin nh√¢n vi√™n v√† l∆∞∆°ng trung b√¨nh.

#### **3. CTE ƒê·ªÜ QUY (T√åM C·∫§P D∆Ø·ªöI C·ª¶A M·ªòT NH√ÇN VI√äN):**

Gi·∫£ s·ª≠ ta c√≥ b·∫£ng `EmployeeHierarchy` (EmployeeID, ManagerID, EmployeeName), trong ƒë√≥ ManagerID ch·ªâ ra ng∆∞·ªùi qu·∫£n l√Ω tr·ª±c ti·∫øp.

```sql
WITH EmployeeHierarchyCTE AS (
    SELECT EmployeeID, ManagerID, EmployeeName, 0 AS Level
    FROM EmployeeHierarchy
    WHERE EmployeeID = 100 -- EmployeeID c·∫ßn t√¨m
    UNION ALL
    SELECT e.EmployeeID, e.ManagerID, e.EmployeeName, Level + 1
    FROM EmployeeHierarchy e
    INNER JOIN EmployeeHierarchyCTE c ON e.ManagerID = c.EmployeeID
)
SELECT EmployeeID, EmployeeName, Level
FROM EmployeeHierarchyCTE
ORDER BY Level;
```

-   **Gi·∫£i th√≠ch:**
    -   T·∫°o CTE ƒë·ªá quy `EmployeeHierarchyCTE` ƒë·ªÉ t√¨m t·∫•t c·∫£ c√°c c·∫•p d∆∞·ªõi c·ªßa nh√¢n vi√™n c√≥ `EmployeeID = 100`.
    -   Ph·∫ßn ƒë·∫ßu (anchor) ch·ªçn nh√¢n vi√™n c√≥ ID l√† 100, Level = 0.
    -   Ph·∫ßn ƒë·ªá quy ch·ªçn c√°c nh√¢n vi√™n l√† c·∫•p d∆∞·ªõi d·ª±a tr√™n `ManagerID`.
    -   D√πng `UNION ALL` ƒë·ªÉ k·∫øt h·ª£p k·∫øt qu·∫£ c·ªßa c·∫£ ph·∫ßn anchor v√† ph·∫ßn ƒë·ªá quy.

### **IV. ∆ØU ƒêI·ªÇM C·ª¶A CTE (NH·ªÆNG ƒêI·ªÇM "ƒê√ÅNG Y√äU")**

-   **D·ªÖ ƒë·ªçc:** Chia nh·ªè query ph·ª©c t·∫°p th√†nh c√°c ph·∫ßn nh·ªè d·ªÖ hi·ªÉu.
-   **T√°i s·ª≠ d·ª•ng:** D√πng l·∫°i CTE ·ªü nhi·ªÅu n∆°i trong c√πng m·ªôt query.
-   **ƒê·ªá quy:** C√≥ th·ªÉ d√πng ƒë·ªÉ t·∫°o truy v·∫•n ƒë·ªá quy (t√≠nh to√°n theo c·∫•p).
-   **Thay th·∫ø View:** ƒê√¥i khi d√πng CTE thay v√¨ t·∫°o view (n·∫øu ch·ªâ d√πng trong query hi·ªán t·∫°i).

### **V. NH∆Ø·ª¢C ƒêI·ªÇM C·ª¶A CTE (ƒêI·ªÇM "KH√ì CH·ªäU")**

-   **Ch·ªâ d√πng trong 1 query:** CTE ch·ªâ t·ªìn t·∫°i trong c√¢u query hi·ªán t·∫°i.
-   **Kh√¥ng c√≥ ch·ªâ m·ª•c:** Kh√¥ng t·∫°o ƒë∆∞·ª£c index cho CTE.
-   **Ph·ª©c t·∫°p h∆°n khi m·ªõi l√†m quen:** C√≥ th·ªÉ m·∫•t th·ªùi gian ƒë·ªÉ l√†m quen v·ªõi CTE ƒë·ªá quy.

### **VI. L∆ØU √ù QUAN TR·ªåNG (ƒê·ªÇ KH√îNG B·ªä "SAI S√ìT")**

-   **ƒê·∫∑t t√™n r√µ r√†ng:** ƒê·∫∑t t√™n CTE d·ªÖ hi·ªÉu, m√¥ t·∫£ ƒë∆∞·ª£c m·ª•c ƒë√≠ch.
-   **D√πng khi c·∫ßn thi·∫øt:** Kh√¥ng n√™n d√πng CTE qu√° nhi·ªÅu, l√†m query kh√≥ ƒë·ªçc.
-   **Khi d√πng ƒë·ªá quy:** C·∫ßn c√≥ ƒëi·ªÉm d·ª´ng, ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n.
-   **Hi·ªáu su·∫•t:** C√≥ th·ªÉ kh√¥ng c·∫£i thi·ªán hi·ªáu su·∫•t (ch·ªâ gi√∫p code d·ªÖ hi·ªÉu).

### **VII. K·∫æT LU·∫¨N (T·ªîNG K·∫æT)**

CTE l√† m·ªôt c√¥ng c·ª• m·∫°nh m·∫Ω gi√∫p b·∫°n vi·∫øt c√°c truy v·∫•n ph·ª©c t·∫°p m·ªôt c√°ch d·ªÖ d√†ng h∆°n trong SQL Server. Hy v·ªçng qua b√†i vi·∫øt n√†y, c√°c b·∫°n ƒë√£ hi·ªÉu r√µ h∆°n v·ªÅ n√≥ v√† c√≥ th·ªÉ √°p d·ª•ng v√†o c√¥ng vi·ªác h√†ng ng√†y. Ch√∫c c√°c b·∫°n code th√†nh c√¥ng! üòé

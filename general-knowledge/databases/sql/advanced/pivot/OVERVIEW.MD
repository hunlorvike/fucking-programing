## **üöÄ "GI·∫¢I M√É" PIVOT V√Ä UNPIVOT TRONG SQL SERVER: XOAY CHUY·ªÇN D·ªÆ LI·ªÜU CHO D√ÇN CODE üöÄ**

Yo c√°c b·∫°n sinh vi√™n IT! H√¥m nay ch√∫ng ta s·∫Ω c√πng nhau "kh√°m ph√°" hai c√¢u l·ªánh ƒë·∫∑c bi·ªát trong SQL Server: `PIVOT` v√† `UNPIVOT`. ƒê√¢y l√† nh·ªØng "chi√™u th·ª©c" l·ª£i h·∫°i gi√∫p b·∫°n bi·∫øn ƒë·ªïi c·∫•u tr√∫c d·ªØ li·ªáu, l√†m cho d·ªØ li·ªáu d·ªÖ ƒë·ªçc, d·ªÖ ph√¢n t√≠ch h∆°n. C√πng m√¨nh "m·ªï x·∫ª" ch√∫ng nh√©!

### **I. PIVOT V√Ä UNPIVOT L√Ä G√å? (XOAY D·ªÆ LI·ªÜU KI·ªÇU G√å?)**

-   **`PIVOT`:** L√† c√¢u l·ªánh d√πng ƒë·ªÉ _xoay_ d·ªØ li·ªáu t·ª´ d·∫°ng h√†ng (rows) sang d·∫°ng c·ªôt (columns).
    -   Gi·ªëng nh∆∞ khi b·∫°n bi·∫øn m·ªôt b·∫£ng d·ªçc th√†nh m·ªôt b·∫£ng ngang ƒë·ªÉ d·ªÖ nh√¨n h∆°n.
-   **`UNPIVOT`:** L√† c√¢u l·ªánh ng∆∞·ª£c l·∫°i, d√πng ƒë·ªÉ _xoay_ d·ªØ li·ªáu t·ª´ d·∫°ng c·ªôt sang d·∫°ng h√†ng.
    -   Gi·ªëng nh∆∞ khi b·∫°n bi·∫øn b·∫£ng ngang th√†nh b·∫£ng d·ªçc.
-   **Quan tr·ªçng v√¨:**
    -   **Bi·∫øn ƒë·ªïi d·ªØ li·ªáu:** Thay ƒë·ªïi c·∫•u tr√∫c d·ªØ li·ªáu (h√†ng th√†nh c·ªôt, c·ªôt th√†nh h√†ng).
    -   **B√°o c√°o:** D√πng ƒë·ªÉ t·∫°o b√°o c√°o d·ªÖ ƒë·ªçc h∆°n.
    -   **Ph√¢n t√≠ch:** Gi√∫p ph√¢n t√≠ch d·ªØ li·ªáu d·ªÖ d√†ng h∆°n.

### **II. C√ö PH√ÅP C∆† B·∫¢N (C√ÅCH D√ôNG PIVOT V√Ä UNPIVOT)**

#### **2.1. `PIVOT` (XOAY D·ªÆ LI·ªÜU T·ª™ H√ÄNG TH√ÄNH C·ªòT)**

```sql
SELECT column1, [value1], [value2], ...
FROM (
    SELECT column1, column2, value_column
    FROM table_name
) AS source_table
PIVOT (
    aggregate_function(value_column)
    FOR column2 IN ([value1], [value2], ...)
) AS pivot_table;
```

-   **`SELECT column1, [value1], [value2], ...`:** Ch·ªçn c√°c c·ªôt v√† c√°c gi√° tr·ªã c·∫ßn xoay th√†nh c·ªôt.
-   **`FROM ( SELECT ... FROM table_name) AS source_table`:** T·∫°o m·ªôt b·∫£ng t·∫°m (subquery) ch·ª©a d·ªØ li·ªáu c·∫ßn xoay.
-   **`PIVOT (aggregate_function(value_column) FOR column2 IN ([value1], [value2], ...))`:** Th·ª±c hi·ªán ph√©p xoay.
    -   `aggregate_function()`: H√†m t·ªïng h·ª£p (COUNT, SUM, AVG, ...).
    -   `value_column`: C·ªôt ch·ª©a gi√° tr·ªã c·∫ßn t√≠nh t·ªïng.
    -   `column2`: C·ªôt ch·ª©a c√°c gi√° tr·ªã c·∫ßn chuy·ªÉn th√†nh t√™n c·ªôt.
    -   `[value1], [value2], ...`: C√°c gi√° tr·ªã c·ªôt 2 s·∫Ω chuy·ªÉn th√†nh c·ªôt.

#### **2.2. `UNPIVOT` (XOAY D·ªÆ LI·ªÜU T·ª™ C·ªòT TH√ÄNH H√ÄNG)**

```sql
SELECT column1, column2, value_column
FROM (
    SELECT column1, [value1], [value2], ...
    FROM table_name
) AS unpivot_table
UNPIVOT (
    value_column FOR column2 IN ([value1], [value2], ...)
) AS unpivot_result;
```

-   **`SELECT column1, column2, value_column`:** Ch·ªçn c√°c c·ªôt c·∫ßn l·∫•y sau khi xoay.
-   **`FROM ( SELECT ... FROM table_name) AS unpivot_table`:** T·∫°o b·∫£ng t·∫°m (subquery) ch·ª©a d·ªØ li·ªáu c·∫ßn xoay.
-   **`UNPIVOT (value_column FOR column2 IN ([value1], [value2], ...))`:** Th·ª±c hi·ªán ph√©p xoay.
    -   `value_column`: C·ªôt m·ªõi ch·ª©a c√°c gi√° tr·ªã t·ª´ c√°c c·ªôt c≈©.
    -   `column2`: C·ªôt m·ªõi ch·ª©a t√™n c·ªßa c√°c c·ªôt c≈©.
    -   `[value1], [value2], ...`: C√°c c·ªôt c·∫ßn chuy·ªÉn th√†nh h√†ng.

### **IV. V√ç D·ª§ MINH H·ªåA (XEM "TH·ª∞C H√ÄNH")**

Gi·∫£ s·ª≠ ta c√≥ b·∫£ng:

-   **`Sales`:** (Year, Quarter, Product, Revenue)

#### **1. `PIVOT` (L·∫§Y DOANH THU THEO NƒÇM):**

```sql
SELECT Product, [Q1], [Q2], [Q3], [Q4]
FROM (
    SELECT Year, Quarter, Product, Revenue
    FROM Sales
) AS SourceTable
PIVOT (
    SUM(Revenue)
    FOR Quarter IN ([Q1], [Q2], [Q3], [Q4])
) AS PivotTable
ORDER BY Product;
```

-   **Gi·∫£i th√≠ch:**
    -   L·∫•y doanh thu theo t·ª´ng s·∫£n ph·∫©m v√† qu√Ω (t·ª´ d·∫°ng h√†ng sang c·ªôt).
    -   `SUM(Revenue)`: T√≠nh t·ªïng doanh thu.
    -   `FOR Quarter IN ([Q1], [Q2], [Q3], [Q4])`: Chuy·ªÉn c√°c gi√° tr·ªã `Q1`, `Q2`, `Q3`, `Q4` th√†nh c·ªôt.
-   **Output:**

| Product | Q1   | Q2   | Q3   | Q4   |
| ------- | ---- | ---- | ---- | ---- |
| Laptop  | 1000 | 1200 | 1500 | 1300 |
| Phone   | 800  | 900  | 1100 | 1000 |
| Tablet  | 500  | 600  | 700  | 800  |

#### **2. `UNPIVOT` (BI·∫æN D·ªÆ LI·ªÜU THEO NƒÇM TH√ÄNH D·∫†NG H√ÄNG):**

```sql
SELECT Product, Quarter, Revenue
FROM (
  SELECT Product, Q1, Q2, Q3, Q4
  FROM (
    SELECT Product, SUM(Revenue) AS Q1, SUM(Revenue) AS Q2, SUM(Revenue) AS Q3, SUM(Revenue) AS Q4
     FROM Sales
    GROUP BY Product
   ) AS P
  ) AS SourceTable
UNPIVOT (
    Revenue FOR Quarter IN ([Q1], [Q2], [Q3], [Q4])
) AS UnpivotTable
ORDER BY Product;
```

-   **Gi·∫£i th√≠ch:**
    -   Chuy·ªÉn d·ªØ li·ªáu doanh thu theo qu√Ω (t·ª´ c·ªôt th√†nh h√†ng).
    -   `Revenue FOR Quarter IN ([Q1], [Q2], [Q3], [Q4])`: Chuy·ªÉn c√°c c·ªôt `Q1`, `Q2`, `Q3`, `Q4` th√†nh h√†ng.
-   **Output:**

| Product | Quarter | Revenue |
| ------- | ------- | ------- |
| Laptop  | Q1      | 1000    |
| Laptop  | Q2      | 1200    |
| Laptop  | Q3      | 1500    |
| Laptop  | Q4      | 1300    |
| Phone   | Q1      | 800     |
| Phone   | Q2      | 900     |
| Phone   | Q3      | 1100    |
| Phone   | Q4      | 1000    |
| Tablet  | Q1      | 500     |
| Tablet  | Q2      | 600     |
| Tablet  | Q3      | 700     |
| Tablet  | Q4      | 800     |

### **V. L∆ØU √ù QUAN TR·ªåNG (ƒê·ªÇ KH√îNG B·ªä "SAI S√ìT")**

-   **D√πng khi c·∫ßn thi·∫øt:** Ch·ªâ n√™n d√πng `PIVOT` v√† `UNPIVOT` khi c·∫ßn thay ƒë·ªïi c·∫•u tr√∫c d·ªØ li·ªáu, kh√¥ng n√™n d√πng qu√° nhi·ªÅu.
-   **Ki·ªÉm tra d·ªØ li·ªáu:** C·∫ßn hi·ªÉu r√µ c·∫•u tr√∫c d·ªØ li·ªáu tr∆∞·ªõc v√† sau khi xoay.
-   **Ch√∫ √Ω h√†m t·ªïng h·ª£p:** D√πng ƒë√∫ng h√†m t·ªïng h·ª£p v·ªõi d·ªØ li·ªáu c·∫ßn xoay (SUM, AVG, ...).
-   **S·ªë l∆∞·ª£ng c·ªôt/h√†ng:** Bi·∫øt r√µ s·ªë l∆∞·ª£ng c·ªôt v√† h√†ng tr∆∞·ªõc khi th·ª±c hi·ªán.
-   **Hi·ªáu su·∫•t:** N·∫øu b·∫£ng l·ªõn, c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn hi·ªáu su·∫•t.

### **VI. K·∫æT LU·∫¨N (T·ªîNG K·∫æT)**

`PIVOT` v√† `UNPIVOT` l√† hai c√¥ng c·ª• r·∫•t h·ªØu √≠ch ƒë·ªÉ bi·∫øn ƒë·ªïi d·ªØ li·ªáu trong SQL Server. Hy v·ªçng qua b√†i vi·∫øt n√†y, c√°c b·∫°n ƒë√£ hi·ªÉu r√µ h∆°n v·ªÅ ch√∫ng v√† c√≥ th·ªÉ √°p d·ª•ng v√†o c√°c b√°o c√°o, ph√¢n t√≠ch c·ªßa m√¨nh. Ch√∫c c√°c b·∫°n code th√†nh c√¥ng! üòé

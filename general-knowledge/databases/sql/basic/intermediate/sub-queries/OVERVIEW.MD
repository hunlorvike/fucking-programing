## **üöÄ "GI·∫¢I M√É" SUBQUERY TRONG SQL SERVER: "QUERY CON" CHO D√ÇN CODE üöÄ**

Yo c√°c b·∫°n sinh vi√™n IT! H√¥m nay ch√∫ng ta s·∫Ω c√πng nhau "kh√°m ph√°" m·ªôt kh√°i ni·ªám c·ª±c k·ª≥ quan tr·ªçng v√† hay d√πng trong SQL
Server: Subquery (Truy v·∫•n con). ƒê√¢y l√† m·ªôt "chi√™u th·ª©c" gi√∫p b·∫°n l√†m nh·ªØng ƒëi·ªÅu ph·ª©c t·∫°p v·ªõi database b·∫±ng c√°ch "l·ªìng"
m·ªôt truy v·∫•n v√†o trong m·ªôt truy v·∫•n kh√°c. C√πng m√¨nh "m·ªï x·∫ª" n√≥ nh√©!

### **I. SUBQUERY L√Ä G√å? (TRUY V·∫§N L·ªíNG TRONG QUERY)**

- **Subquery (Truy v·∫•n con):** L√† m·ªôt c√¢u l·ªánh `SELECT` ƒë∆∞·ª£c _l·ªìng b√™n trong_ m·ªôt c√¢u l·ªánh SQL kh√°c.
- **N√≥ ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?**
    - Gi·ªëng nh∆∞ khi b·∫°n l√†m m·ªôt b√†i to√°n l·ªõn, b·∫°n c·∫ßn ph·∫£i gi·∫£i quy·∫øt c√°c b√†i to√°n nh·ªè tr∆∞·ªõc (b√†i to√°n con), r·ªìi m·ªõi
      d√πng k·∫øt qu·∫£ c·ªßa b√†i to√°n nh·ªè ƒë·ªÉ gi·∫£i b√†i to√°n l·ªõn (truy v·∫•n ch√≠nh).
- **Quan tr·ªçng v√¨:**
    - **Linh ho·∫°t:** T·∫°o ra c√°c truy v·∫•n ph·ª©c t·∫°p, m·∫°nh m·∫Ω h∆°n.
    - **Gi·∫£m code:** Thay v√¨ vi·∫øt nhi·ªÅu c√¢u l·ªánh, d√πng subquery ƒë·ªÉ l√†m trong 1 c√¢u l·ªánh.
    - **T√°i s·ª≠ d·ª•ng:** C√≥ th·ªÉ d√πng l·∫°i subquery ·ªü nhi·ªÅu n∆°i.

### **II. C√ÅCH D√ôNG SUBQUERY (L·ªíNG "QUERY" V√ÄO "QUERY")**

#### **2.1. SUBQUERY TRONG `SELECT` (T·∫†O C·ªòT T√çNH TO√ÅN)**

```sql
SELECT column1, column2, (SELECT some_value FROM some_table WHERE condition) AS calculated_column
FROM table_name;
```

- Subquery tr·∫£ v·ªÅ _m·ªôt gi√° tr·ªã_, d√πng ƒë·ªÉ t·∫°o c·ªôt t√≠nh to√°n.
- **V√≠ d·ª•:** T√≠nh s·ªë l∆∞·ª£ng nh√¢n vi√™n trong m·ªói ph√≤ng ban:

```sql
SELECT name, salary,
    (SELECT COUNT(*) FROM Employees e WHERE e.DepartmentID = d.DepartmentID) AS NumEmployees
FROM Employees e
JOIN Departments d ON e.DepartmentID = d.DepartmentID;
```

#### **2.2. SUBQUERY TRONG `WHERE` (L·ªåC D·ª∞A TR√äN K·∫æT QU·∫¢ QUERY KH√ÅC)**

```sql
SELECT column1, column2, ...
FROM table_name
WHERE column_name IN/=/</>/... (SELECT ... FROM another_table WHERE condition);
```

- Subquery d√πng ƒë·ªÉ _l·ªçc_ d·ªØ li·ªáu, tr·∫£ v·ªÅ m·ªôt gi√° tr·ªã ho·∫∑c t·∫≠p h·ª£p c√°c gi√° tr·ªã.
- **V√≠ d·ª•:** L·∫•y nh√¢n vi√™n ·ªü ph√≤ng ban IT:

```sql
SELECT name, salary
FROM Employees
WHERE DepartmentID = (SELECT DepartmentID FROM Departments WHERE DepartmentName = 'IT');
```

#### **2.3. SUBQUERY TRONG `FROM` (T·∫†O B·∫¢NG T·∫†M)**

```sql
SELECT column1, column2, ...
FROM (SELECT ... FROM another_table WHERE ...) AS subquery_alias
WHERE condition;
```

- Subquery t·∫°o ra m·ªôt _b·∫£ng t·∫°m_ (table) cho truy v·∫•n ch√≠nh d√πng.
- **V√≠ d·ª•:** T√≠nh l∆∞∆°ng trung b√¨nh cho t·ª´ng ph√≤ng ban:

```sql
SELECT DepartmentID, AVG(Salary) AS AvgSalary
FROM (SELECT DepartmentID, Salary FROM Employees) AS Sub
GROUP BY DepartmentID;
```

### **III. C√ÅC LO·∫†I SUBQUERY (C√ì NHI·ªÄU "KI·ªÇU" L·ªíNG)**

1. **Subquery t∆∞∆°ng ƒë∆∞∆°ng:** Tr·∫£ v·ªÅ _m·ªôt gi√° tr·ªã_ (th∆∞·ªùng d√πng v·ªõi `=`, `>`, `<`, ...).
2. **Subquery tr·∫£ v·ªÅ 1 gi√° tr·ªã:** Tr·∫£ v·ªÅ _m·ªôt gi√° tr·ªã duy nh·∫•t_.
3. **Subquery tr·∫£ v·ªÅ nhi·ªÅu gi√° tr·ªã:** Tr·∫£ v·ªÅ _m·ªôt t·∫≠p h·ª£p gi√° tr·ªã_ (d√πng v·ªõi `IN`, `ANY`, `ALL`).
4. **Subquery tr·∫£ v·ªÅ b·∫£ng:** Tr·∫£ v·ªÅ _m·ªôt b·∫£ng_ (d√πng trong `FROM`).

### **IV. K·∫æT H·ª¢P SUBQUERY (D√ôNG "COMBO" C√ÅC "CHI√äU")**

#### **4.1. SUBQUERY V·ªöI `IN` (KI·ªÇM TRA C√ì TRONG T·∫¨P H·ª¢P)**

```sql
SELECT name, salary
FROM Employees
WHERE DepartmentID IN (SELECT DepartmentID FROM Departments WHERE DepartmentName IN ('HR', 'IT'));
```

#### **4.2. SUBQUERY V·ªöI `EXISTS` (KI·ªÇM TRA T·ªíN T·∫†I)**

```sql
SELECT name, salary
FROM Employees e
WHERE EXISTS (SELECT 1 FROM Departments d WHERE e.DepartmentID = d.DepartmentID AND d.DepartmentName = 'HR');
```

#### **4.3. SUBQUERY V·ªöI `JOIN` (K·∫æT H·ª¢P D·ªÆ LI·ªÜU)**

```sql
SELECT e.name, e.salary
FROM Employees e
JOIN (SELECT DepartmentID FROM Departments WHERE DepartmentName = 'HR') d
ON e.DepartmentID = d.DepartmentID;
```

### **V. V√ç D·ª§ TH·ª∞C T·∫æ (XEM "TH·ª∞C H√ÄNH")**

1. **L·∫•y nh√¢n vi√™n l∆∞∆°ng cao nh·∫•t:**

```sql
SELECT name, salary
FROM Employees
WHERE salary = (SELECT MAX(salary) FROM Employees);
```

2. **L·∫•y nh√¢n vi√™n ·ªü ph√≤ng ban HR ho·∫∑c IT:**

```sql
SELECT name, salary
FROM Employees
WHERE DepartmentID IN (SELECT DepartmentID FROM Departments WHERE DepartmentName IN ('HR', 'IT'));
```

3. **L·∫•y nh√¢n vi√™n c√≥ ph√≤ng ban HR (d√πng EXISTS):**

```sql
SELECT name, salary
FROM Employees e
WHERE EXISTS (SELECT 1 FROM Departments d WHERE e.DepartmentID = d.DepartmentID AND d.DepartmentName = 'HR');
```

4. **L·∫•y t√™n v√† l∆∞∆°ng nh√¢n vi√™n, k·∫øt h·ª£p v·ªõi t√™n ph√≤ng ban (d√πng JOIN v·ªõi subquery):**

```sql
SELECT e.name, e.salary
FROM Employees e
JOIN (SELECT DepartmentID FROM Departments WHERE DepartmentName = 'HR') d
ON e.DepartmentID = d.DepartmentID;
```

### **VI. L∆ØU √ù QUAN TR·ªåNG (ƒê·ªÇ KH√îNG B·ªä "SAI S√ìT")**

- **Hi·ªáu su·∫•t:** Subquery c√≥ th·ªÉ l√†m ch·∫≠m query (nh·∫•t l√† khi subquery tr·∫£ v·ªÅ nhi·ªÅu d·ªØ li·ªáu).
- **ƒê·ªô ph·ª©c t·∫°p:** Subquery c√≥ th·ªÉ l√†m code kh√≥ hi·ªÉu (tr√°nh l·ªìng qu√° nhi·ªÅu).
- **D√πng khi c·∫ßn thi·∫øt:** Kh√¥ng n√™n d√πng subquery khi c√≥ c√°ch kh√°c ƒë∆°n gi·∫£n h∆°n (v√≠ d·ª•: d√πng `JOIN` thay v√¨ subquery).
- **Index:** C√≥ th·ªÉ c·∫ßn index ƒë·ªÉ subquery ch·∫°y nhanh h∆°n.
- **Xem Execution Plan:** D√πng Execution Plan ƒë·ªÉ ki·ªÉm tra t·ªëc ƒë·ªô subquery.

### **VII. K·∫æT LU·∫¨N (T·ªîNG K·∫æT)**

Subquery l√† m·ªôt c√¥ng c·ª• r·∫•t h·ªØu √≠ch gi√∫p b·∫°n t·∫°o ra c√°c truy v·∫•n ph·ª©c t·∫°p v√† linh ho·∫°t h∆°n trong SQL Server. Hy v·ªçng qua
b√†i vi·∫øt n√†y, c√°c b·∫°n ƒë√£ hi·ªÉu r√µ h∆°n v·ªÅ n√≥ v√† c√≥ th·ªÉ √°p d·ª•ng v√†o c√¥ng vi·ªác h√†ng ng√†y c·ªßa m√¨nh. Ch√∫c c√°c b·∫°n code th√†nh
c√¥ng! üòé
